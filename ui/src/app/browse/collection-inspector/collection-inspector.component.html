@let cd = comboData();
@if (!cd || (comboDataResource.isLoading() && !hideLoading())) {
  <mat-spinner></mat-spinner>
} @else {
  <app-collection-header
    [collection]="collection()"
    [title]="cd.collection.name"
    [upstream]="cd.upstream"
  >
  <div
    class="spaced-btn {{screen.screenSize()}} collection-btn">
    @if (screen.screenSize() === 'wide') {
      <button
        mat-stroked-button
        extended
        color="warn"
        [disabled]="!hasDelete || !config().permissions.delete"
        (click)="delete()">
        Delete
      </button>
    } @else {
      <button
        mat-icon-button
        color="warn"
        [disabled]="!hasDelete || !config().permissions.delete"
        (click)="delete()">
        <mat-icon>delete</mat-icon>
      </button>
    }
  </div>

  @if (screen.screenSize() === 'wide') {
    <button
      mat-stroked-button
      extended
      class="collection-btn"
      (click)="openInGraph()">
      View on Graph
    </button>
    <button
      mat-stroked-button
      extended
      class="collection-btn"
      [disabled]="!hasUpdate"
      (click)="editTags()">
      Tags
    </button>
    @if (collection() === 'brokerAccount') {
      <button
        mat-stroked-button
        extended
        class="collection-btn"
        [disabled]="!hasUpdate"
        (click)="openAccessToken()">
        Access Token
      </button>
    }
    @if (collection() === 'team') {
      <app-inspector-team
        class="collection-btn"
        [vertex]="cd.vertex.id"
        [name]="cd.collection.name"
        [screenSize]="screen.screenSize()"></app-inspector-team>
    }
    <button
      mat-stroked-button
      extended
      class="collection-btn"
      [disabled]="!hasUpdate || !config().permissions.update"
      (click)="edit()">
      Edit
    </button>
  } @else {
    <button
      mat-icon-button
      class="collection-btn"
      (click)="openInGraph()">
      <mat-icon>account_tree</mat-icon>
    </button>
    <button
      mat-icon-button
      class="collection-btn"
      [disabled]="!hasUpdate"
      (click)="editTags()">
      <mat-icon>label</mat-icon>
    </button>
    @if (collection() === 'brokerAccount') {
      <button
        mat-icon-button
        class="collection-btn"
        [disabled]="!hasUpdate"
        (click)="openAccessToken()">
        <mat-icon>account_box</mat-icon>
      </button>
    }
    @if (collection() === 'team') {
      <app-inspector-team
        class="collection-btn"
        [vertex]="cd.vertex.id"
        [name]="cd.collection.name"
        [screenSize]="screen.screenSize()"></app-inspector-team>
    }
    <button
      mat-icon-button
      class="collection-btn"
      [disabled]="!hasUpdate || !config().permissions.update"
      (click)="edit()">
      <mat-icon>edit</mat-icon>
    </button>
  }

</app-collection-header>
      @let localCollection = collection();
    <div class="inspector-card-layout inspector-tab-margin" [class]="screen.screenSize()">
      <app-vertex-tags
        class="full-width"
        [collection]="collection()"
        [collectionData]="cd.collection"></app-vertex-tags>

      <div>
      <mat-card appearance="outlined" class="inspector-card-gap">
        <mat-card-content>
          <div class="card-title-container">
            <mat-card-title>Details</mat-card-title>
            <div>
              <button mat-icon-button [matMenuTriggerFor]="detailsMenu">
                <mat-icon>more_vert</mat-icon>
              </button>
              <mat-menu #detailsMenu="matMenu">
                <button mat-menu-item [matMenuTriggerFor]="detailsCopyMenu">
                  <mat-icon>content_copy</mat-icon>Copy
                </button>
              </mat-menu>

              <mat-menu #detailsCopyMenu="matMenu">
                <button
                  mat-menu-item
                  [cdkCopyToClipboard]="cd.collection.vertex"
                  >Vertex Id</button>
                <button
                  mat-menu-item
                  [cdkCopyToClipboard]="cd.collection.id"
                  >Collection Id</button>
                <mat-divider></mat-divider>
                @for (item of (config().fields | keyvalue); track item.key) {
                  @if (cd.collection[item.key] && (item.value.type === 'string' || item.value.type === 'email' || item.value.type === 'url')) {
                    <button
                      mat-menu-item
                      [cdkCopyToClipboard]="cd.collection[item.key]"
                      >{{ item.value.name }}</button>
                  }
                }
              </mat-menu>
            </div>
          </div>

          <app-inspector-vertex-fields
            [collection]="collection()"
            [collectionConfig]="config()"
            [collectionData]="cd.collection"
            [filter]="'no'"
            ></app-inspector-vertex-fields>

          @if (cd.vertex.prop) {
            <app-inspector-properties
              [prop]="cd.vertex.prop"></app-inspector-properties>
          }
          <app-inspector-timestamps
            [timestamps]="cd.vertex.timestamps"></app-inspector-timestamps>
        </mat-card-content>
      </mat-card>

      @if (localCollection === 'service') {
        <mat-card appearance="outlined">
          <mat-card-content>
            <div class="card-title-container">
              <mat-card-title>Secrets</mat-card-title>
            </div>
            <app-inspector-vault
              [service]="cd.collection"
              [isAdministrator]="hasSudo()"></app-inspector-vault>
            @if (hasSudo()) {
              <mat-divider></mat-divider>
              <app-inspector-service-secure
                [service]="cd.collection"></app-inspector-service-secure>
            }
          </mat-card-content>
        </mat-card>
      }

      @if (localCollection === 'team') {
        <mat-card appearance="outlined" class="inspector-card-gap">
          <mat-card-content>
            <div class="card-title-container">
              <mat-card-title>Members</mat-card-title>
              <div>
                <button
                  mat-stroked-button
                  (click)="openMemberDialog()"
                  class="card-team-member-button">
                  <mat-icon>edit</mat-icon>
                  Edit
                </button>
              </div>
            </div>
            <div class="card-team-members-margin">
              <app-team-members
                [teamId]="cd.collection.id"
                [refresh]="refresh()"></app-team-members>
            </div>
          </mat-card-content>
        </mat-card>


        <mat-card appearance="outlined">
          <mat-card-content>
            <div class="card-title-container">
              <mat-card-title>Services</mat-card-title>
            </div>

            <div class="card-team-members-margin">
              <app-team-services
                class="full-width order-end"
                [teamVertex]="cd.collection.vertex"></app-team-services>
            </div>
          </mat-card-content>
        </mat-card>
      }
        </div>

      <div>
        <mat-card class="inspector-card-gap" appearance="outlined">
          <mat-card-content>
            <div class="card-title-container">
              <mat-card-title>{{ config().name }}</mat-card-title>
            </div>

            <div class="card-content-container-full">{{ config().hint }}</div>

            @if (localCollection === 'brokerAccount' && cd.vertex.collection === localCollection) {
              <app-inspector-account
                [account]="collectionUtil.narrowCollectionType(localCollection, cd.vertex, cd.collection)"
                [hasSudo]="hasSudo()"></app-inspector-account>
            }

            @if (hasSudo() && localCollection === 'repository' && cd.vertex.collection === localCollection) {
              <app-inspector-repository-sync
                [repository]="collectionUtil.narrowCollectionType(localCollection, cd.vertex, cd.collection)"
                [hasSudo]="hasSudo()"
                [header]="'large'"></app-inspector-repository-sync>
            }
            @if (localCollection === 'team') {

            <div class="card-title-container">
              <mat-card-title>Roles</mat-card-title>
            </div>
              @if(healthStatus.health$ | async; as health) {
                @if(health.details['github']['sync']) {
                  <div>
                    <button
                      mat-stroked-button
                      (click)="showGitHubRoleMappings()"
                      class="card-team-member-button">
                      GitHub Access Help
                    </button>
                  </div>
                }
              }

              <div class="card-team-members-margin">
                <app-team-roles></app-team-roles>
              </div>
            }

            @if (collection() === 'user') {
                <div class="card-title-container">
                  <mat-card-title>Alias</mat-card-title>
                </div>
                <app-user-alias
                [collection]="cd.collection"></app-user-alias>
            }

            <!-- @if (collection() === 'brokerAccount') {
              <div class="card-content-container">
                <button
                  class="{{screen.screenSize()}} collection-btn"
                  mat-stroked-button
                  extended
                  (click)="openBrokerAccountHistory()">
                  History
                </button>
              </div>
            } -->
            @if (collection() === 'service') {
              <div class="card-content-container">
                <button
                  class="{{screen.screenSize()}} collection-btn"
                  mat-stroked-button
                  extended
                  (click)="openServiceBuilds()">
                  Builds
                </button>
                <button
                  class="{{screen.screenSize()}} collection-btn"
                  mat-stroked-button
                  extended
                  (click)="openServiceInstances()">
                  Instances
                </button>
                <button
                  class="{{screen.screenSize()}} collection-btn"
                  mat-stroked-button
                  extended
                  (click)="openServiceHistory()">
                  History
                </button>
              </div>
            }
          </mat-card-content>
        </mat-card>

        <mat-card appearance="outlined">
          <mat-card-content>
            <div class="card-title-container">
              <mat-card-title>Connections</mat-card-title>
            </div>
            <app-inspector-connections
              [collection]="collection()"
              [config]="config()"
              [vertex]="cd.collection.vertex"
              [source]="cd.vertex"
              [upstream]="cd.upstream"
              [downstream]="cd.downstream"
              [hasAdmin]="hasAdmin()"
              (selected)="navigate($event)"
              ></app-inspector-connections>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
}